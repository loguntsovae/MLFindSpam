#!/usr/bin/env python3
"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –º–æ–¥–µ–ª–∏ —Å —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä—É—Å—Å–∫–∏—Ö SMS –Ω–∞ —Å–ø–∞–º –∏ ham.
"""

import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º –ø—Ä–æ–µ–∫—Ç–∞
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.predict import predict_message, predict_proba


def print_header(text):
    """–ö—Ä–∞—Å–∏–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫"""
    print("\n" + "=" * 70)
    print(f"  {text}")
    print("=" * 70)


def test_message(message, expected=None):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
    result = predict_message(message)
    proba = predict_proba(message)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–º–æ–¥–∑–∏
    emoji = "‚ùå" if result == "spam" else "‚úÖ"
    
    # –¶–≤–µ—Ç–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    result_str = f"{emoji} {result.upper()}"
    
    print(f"\nüì± –°–æ–æ–±—â–µ–Ω–∏–µ: \"{message}\"")
    print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: {result_str}")
    print(f"   –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏: HAM={proba['ham']:.2%}, SPAM={proba['spam']:.2%}")
    
    if expected:
        match = "‚úì" if result == expected else "‚úó"
        print(f"   –û–∂–∏–¥–∞–ª–æ—Å—å: {expected.upper()} {match}")


def main():
    print_header("üá∑üá∫ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ú–û–î–ï–õ–ò –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï")
    
    print("\nüìù –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –º–æ–¥–µ–ª–∏ —Å —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.")
    print("   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –º–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –Ω–∞ –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ–º –¥–∞—Ç–∞—Å–µ—Ç–µ!")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–µ–ª–∏
    model_path = Path(__file__).parent.parent / "models" / "model.pkl"
    if not model_path.exists():
        print("\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        print("   –°–Ω–∞—á–∞–ª–∞ –æ–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª—å:")
        print("   1. python src/merge_russian_data.py --update-raw")
        print("   2. python src/prepare.py")
        print("   3. python src/train.py")
        return
    
    # HAM –ø—Ä–∏–º–µ—Ä—ã
    print_header("‚úÖ –ü–†–ò–ú–ï–†–´ HAM (–õ–ï–ì–ò–¢–ò–ú–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô)")
    
    ham_examples = [
        "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞? –ö–æ–≥–¥–∞ –≤—Å—Ç—Ä–µ—Ç–∏–º—Å—è?",
        "–í—Å—Ç—Ä–µ—á–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ –ø—è—Ç–Ω–∏—Ü—É –≤ 15:00",
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–º–æ—â—å, –±–µ–∑ —Ç–µ–±—è –±—ã –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è",
        "–ó–∞–≤—Ç—Ä–∞ –≤ –æ—Ñ–∏—Å –º–æ–∂–Ω–æ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å, —Ä–∞–±–æ—Ç–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ",
        "–í—Ä–∞—á —Å–∫–∞–∑–∞–ª —á—Ç–æ –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ, –º–æ–∂–Ω–æ –Ω–µ –≤–æ–ª–Ω–æ–≤–∞—Ç—å—Å—è",
        "–ù–µ –∑–∞–±—É–¥—å –∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ –∏ —Ö–ª–µ–± –ø–æ –¥–æ—Ä–æ–≥–µ –¥–æ–º–æ–π",
    ]
    
    for msg in ham_examples:
        test_message(msg, expected="ham")
    
    # SPAM –ø—Ä–∏–º–µ—Ä—ã
    print_header("‚ùå –ü–†–ò–ú–ï–†–´ SPAM (–ú–û–®–ï–ù–ù–ò–ß–ï–°–ö–ò–• –°–û–û–ë–©–ï–ù–ò–ô)")
    
    spam_examples = [
        "–°–†–û–ß–ù–û! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ iPhone 15 Pro! –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ",
        "–í–ù–ò–ú–ê–ù–ò–ï! –í–∞—à–∞ –∫–∞—Ä—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞! –°—Ä–æ—á–Ω–æ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ 8-XXX-XXX-XXXX",
        "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞–º –æ–¥–æ–±—Ä–µ–Ω –∫—Ä–µ–¥–∏—Ç –¥–æ 500000 —Ä—É–±–ª–µ–π –±–µ–∑ —Å–ø—Ä–∞–≤–æ–∫!",
        "–¢–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è! –°–∫–∏–¥–∫–∞ 90% –Ω–∞ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã! –£—Å–ø–µ–π –∫—É–ø–∏—Ç—å!",
        "–ó–∞—Ä–∞–±–æ—Ç–æ–∫ –æ—Ç 50000 —Ä—É–±–ª–µ–π –≤ –¥–µ–Ω—å –±–µ–∑ –≤–ª–æ–∂–µ–Ω–∏–π!",
        "–ë–ï–°–ü–õ–ê–¢–ù–ê–Ø —Ä–∞–∑–¥–∞—á–∞ –¥–µ–Ω–µ–≥! –ü–µ—Ä–≤—ã–º 100 —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –ø–æ 10000 —Ä—É–±!",
    ]
    
    for msg in spam_examples:
        test_message(msg, expected="spam")
    
    # –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
    print_header("‚ö†Ô∏è  –ì–†–ê–ù–ò–ß–ù–´–ï –°–õ–£–ß–ê–ò")
    
    edge_cases = [
        "–ê–∫—Ü–∏—è! –°–∫–∏–¥–∫–∞ 20% –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É SUMMER2024 –≤ –Ω–∞—à–µ–º –º–∞–≥–∞–∑–∏–Ω–µ",
        "–í–∞—à –∑–∞–∫–∞–∑ ‚Ññ12345 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –¢—Ä–µ–∫-–Ω–æ–º–µ—Ä: 123456789",
        "–°—Ä–æ—á–Ω–æ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å! –ü–æ–∑–≤–æ–Ω–∏ –∫–∞–∫ —Ç–æ–ª—å–∫–æ —Å–º–æ–∂–µ—à—å",
        "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ø–ª–∞—Ç–µ–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É 15 —á–∏—Å–ª–∞",
    ]
    
    for msg in edge_cases:
        test_message(msg)
    
    # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
    print_header("üéÆ –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –†–ï–ñ–ò–ú")
    print("\n–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∏–ª–∏ 'exit' –¥–ª—è –≤—ã—Ö–æ–¥–∞):")
    
    while True:
        try:
            user_input = input("\nüì± > ").strip()
            
            if user_input.lower() in ['exit', 'quit', '–≤—ã—Ö–æ–¥']:
                print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                break
            
            if not user_input:
                continue
            
            test_message(user_input)
            
        except KeyboardInterrupt:
            print("\n\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
            break
        except Exception as e:
            print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
    
    print_header("‚ú® –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")
    print("\nüí° –°–æ–≤–µ—Ç—ã:")
    print("   ‚Ä¢ –î–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ russian_messages.csv")
    print("   ‚Ä¢ –ü–µ—Ä–µ–æ–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
    print("   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: python ui/app.py")


if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
